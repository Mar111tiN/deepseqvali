def IR_ref(_):
    '''
    returns ref parameters for realign-refs gatk tools
    '''

    return f"-R {full_path('genome')} -known {full_path('gold_standard_indels')} -known {full_path('phase1k_indels')}"


rule create_GATK_target_list:
    input:
        unpack(get_IR_input)
    output:
        "realigned/{sample}.intervals"
    threads:
        config['realignGATK']['threads']
    log:
        "logs/realign/{sample}.targetList"
    conda:
        f"../{config['envs']}/gatk3-env.yml"
    params:
        gatk = config['tools']['gatk3'],
        ref = IR_ref
    shell:
        "{params.gatk} RealignerTargetCreator -nt {threads} {params.ref} -I {input.bam} -o {output}"


rule realignGATK:
    input:
        unpack(get_IR_input),
        intervals = "realigned/{sample}.intervals"
    output:
        bam= "realigned/{sample}.bam"
    log:
        "logs/realign/{sample}.log"
    threads:
        config['realignGATK']['threads']
    conda:
        f"../{config['envs']}/gatk3-env.yml"
    params:
        gatk = config['tools']['gatk3'],
        ref = IR_ref,
        deflater = "-jdk_deflater -jdk_inflater" if config['envs'] == "envMac" else ""
    shell:
        "{params.gatk} IndelRealigner {params.deflater} {params.ref} "
        "-targetIntervals {input.intervals} -I {input.bam} -o {output.bam} &>{log}; "


rule base_recalib:
    input:
        bam = "realigned/{sample}.bam"
    output:
        table = "recaltable/{sample}.recal1"
    log:
        "logs/recalib/{sample}.log"
    threads:
        config['recalib']['threads']
    conda:
        f"../{config['envs']}/gatk4-env.yml"
    params:
        gatk = config['tools']['gatk'],
        genome = f"-R {full_path('genome')}",
        known_sites = f"--known-sites {full_path('gold_standard_indels')} --known-sites {full_path('phase1k_indels')} --known-sites {full_path(config['recalib']['known_sites'])}"
    shell:
        "{params.gatk} BaseRecalibrator -I {input.bam} {params.genome} {params.known_sites} -O {output.table} &>{log}; "


# here I need a switch to just split 
rule apply_BQSR:
    input:
        bam = "realigned/{sample}.bam",
        table = "recaltable/{sample}.recal1"
    output:
        bam = "recalib/{sample}.bam",
        table = "recaltable/{sample}.recal2"
    threads:
        config['recalib']['threads']
    conda:
        f"../{config['envs']}/gatk4-env.yml"
    params:
        gatk = config['tools']['gatk'],
        genome = f"-R {full_path('genome')}",
        known_sites = f"--known-sites {full_path('gold_standard_indels')} --known-sites {full_path('phase1k_indels')} --known-sites {full_path(config['recalib']['known_sites'])}"  
    shell:
        # apply recalibration table on input
        "{params.gatk} ApplyBQSR -I {input.bam} {params.genome} --bqsr-recal-file {input.table} -O {output.bam}; "  #  &>>{log}
        # recreate recalibration table from output for QC
        "{params.gatk} BaseRecalibrator -I {output.bam} {params.genome} {params.known_sites} -O {output.table}; "  #  &>>{log}

rule index_bam:
    input:
        bam = "{folder}/{sample}.bam"
    output:
        bai = "{folder}/{sample}.bai"
    threads: 1
    conda:
        f"../{config['envs']}/align-env.yml"
    shell:
        "picard BuildBamIndex I={input.bam}"